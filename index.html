<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>เติมเครดิต + เช็คเครดิต (OCR)</title>
<style>
  body{font-family:Arial, sans-serif;max-width:600px;margin:20px auto;padding:10px}
  input,button{width:100%;padding:10px;margin:8px 0;font-size:16px}
  #result,#creditBox{margin-top:12px;padding:10px;border:1px solid #ddd;border-radius:6px;display:none}
  #preview img{max-width:100%;height:auto}
  .muted{color:#666;font-size:14px}
</style>
</head>
<body>

  <h2>ระบบเติมเครดิตด้วยสลิป (OCR)</h2>

  <!-- ==================== USER + CREDIT ==================== -->
  <label>ยูสเซอร์เนม</label>
  <input id="username" placeholder="user001">

  <button onclick="checkCredit()">ดูเครดิตปัจจุบัน</button>

  <div id="creditBox"></div>

  <!-- ==================== TOPUP ==================== -->
  <label>จำนวนเงินที่ต้องการเติม (บาท)</label>
  <input id="amount" type="number" placeholder="150">

  <label>อัปโหลดรูปสลิป</label>
  <input id="file" type="file" accept="image/*">

  <div id="preview" style="display:none;margin-top:8px">
    <div class="muted">ตัวอย่างภาพสลิป</div>
    <div id="imgwrap"></div>
  </div>

  <button id="btn" onclick="processSlip()">ตรวจสลิปและเติมเครดิต</button>

  <div id="result"></div>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

  <script>
  // ==================== CONFIG (แก้ตรงนี้!) ====================
  const API_URL_GAS = "https://script.google.com/macros/s/AKfycbwHAFPOPO4DrDYU04NWBEMdysWESDE0wNJD2N65hok-UNdSweBr8o8j7vhngrjg5OaA/exec";
  const SECRET = "yahari";

  // ---------------------- CREDIT CHECK ----------------------
  async function checkCredit(){
    const username = document.getElementById("username").value.trim();
    const box = document.getElementById("creditBox");

    if(!username){
      alert("กรุณากรอกยูสเซอร์");
      return;
    }

    box.style.display = "block";
    box.innerHTML = "กำลังดึงข้อมูล...";

    try {
      const resp = await fetch(API_URL_GAS + "?action=get_credit&username=" + encodeURIComponent(username));
      const data = await resp.json();

      if(data.error){
        box.innerHTML = "<span style='color:red'>Error: "+data.error+"</span>";
      }else{
        box.innerHTML = `
          <b>ยูสเซอร์:</b> ${data.username}<br>
          <b>เครดิตคงเหลือ:</b> ${data.credit} บาท
        `;
      }
    } catch(err){
      box.innerHTML = "<span style='color:red'>Error: "+err.message+"</span>";
    }
  }

  // ---------------------- OCR + TOPUP ----------------------
  function toBase64(file) {
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result.split(',')[1]);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
  }

  function parseAmountFromText(text) {
    const matches = text.match(/([0-9]{1,3}(?:[,\s][0-9]{3})*(?:\.[0-9]+)?|\d+(?:\.\d+)?)/g);
    if (!matches) return null;

    const nums = matches.map(s => Number(s.replace(/\s/g,'').replace(/,/g,'')))
                        .filter(n => !isNaN(n));

    if (!nums.length) return null;

    nums.sort((a,b) => b - a);
    return nums[0];
  }

  async function processSlip(){
    const btn = document.getElementById('btn');
    btn.disabled = true;
    btn.innerText = "กำลังประมวลผล...";

    const username = document.getElementById('username').value.trim();
    const amountInput = Number(document.getElementById('amount').value);
    const file = document.getElementById('file').files[0];
    const resultEl = document.getElementById('result');

    resultEl.style.display='none';
    resultEl.innerHTML='';

    if(!username || !amountInput || !file){
      alert("กรุณากรอกข้อมูลให้ครบ");
      btn.disabled=false; btn.innerText="ตรวจสลิปและเติมเครดิต";
      return;
    }

    // preview
    const wrap = document.getElementById('imgwrap');
    wrap.innerHTML='';
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    wrap.appendChild(img);
    document.getElementById('preview').style.display='block';

    try {
      // OCR
      const worker = Tesseract.createWorker();
      await worker.load();
      await worker.loadLanguage('eng+tha');
      await worker.initialize('eng+tha');
      const { data:{text} } = await worker.recognize(file);
      await worker.terminate();

      const found = parseAmountFromText(text);

      if(!found){
        resultEl.style.display='block';
        resultEl.innerHTML="<span style='color:red'>ไม่พบยอดเงินในสลิป</span>";
        btn.disabled=false; btn.innerText="ตรวจสลิปและเติมเครดิต";
        return;
      }

      if(Math.abs(found - amountInput) > 0.99){
        resultEl.style.display='block';
        resultEl.innerHTML=`<span style='color:red'>ยอดไม่ตรง OCR ${found} ≠ ${amountInput}</span>`;
        btn.disabled=false; btn.innerText="ตรวจสลิปและเติมเครดิต";
        return;
      }

      // ส่งไป GAS
      const payload = {
        secret: SECRET,
        action: "topup",
        username: username,
        amount: amountInput,
        ocrText: text
      };

      const resp = await fetch(API_URL_GAS,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });

      const data = await resp.json();

      if(data.error){
        resultEl.style.display='block';
        resultEl.innerHTML=`<span style='color:red'>Server error: ${data.error}</span>`;
      }else{
        resultEl.style.display='block';
        resultEl.innerHTML=`<span style='color:green'>เติมสำเร็จ ${amountInput} บาท</span>`;
      }

    } catch(err){
      resultEl.style.display='block';
      resultEl.innerHTML=`<span style='color:red'>Error: ${err.message}</span>`;
    }

    btn.disabled=false;
    btn.innerText="ตรวจสลิปและเติมเครดิต";
  }
  </script>
</body>
</html>
