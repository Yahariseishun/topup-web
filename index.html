<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>เติมเครดิตด้วยสลิป (OCR)</title>
<style>
  body{font-family:Arial, sans-serif;max-width:600px;margin:20px auto;padding:10px}
  input,button{width:100%;padding:10px;margin:8px 0;font-size:16px}
  #result{margin-top:12px;padding:10px;border:1px solid #ddd;border-radius:6px;display:none}
  #preview img{max-width:100%;height:auto}
  .muted{color:#666;font-size:14px}
</style>
</head>
<body>
  <h2>เติมเครดิตด้วยการอัปโหลดสลิป</h2>

  <label>ยูสเซอร์เนม</label>
  <input id="username" placeholder="user001">

  <label>จำนวนเงินที่ต้องการเติม (บาท)</label>
  <input id="amount" type="number" placeholder="150">

  <label>อัปโหลดรูปสลิป (ถ่ายชัด ๆ)</label>
  <input id="file" type="file" accept="image/*">

  <div id="preview" style="display:none;margin-top:8px">
    <div class="muted">ตัวอย่างภาพสลิป</div>
    <div id="imgwrap"></div>
  </div>

  <button id="btn" onclick="processSlip()">ตรวจสลิปและเติมเครดิต</button>

  <div id="result"></div>

  <!-- Tesseract.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

  <script>
  // ====== CONFIG ======
  const API_URL_GAS = "https://script.google.com/macros/s/AKfycbzT7bKsZlf_zLam3L29CUqLjKM0B2dCSaHTdYsXVjCBnSmkXJwjrpO-5ZUxKoEkGqBj/exec"; // จาก Apps Script deploy
  const SECRET = "yahari"; // ให้ตรงกับ GAS

  // ====== Helpers ======
  function toBase64(file) {
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result.split(',')[1]);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
  }

  function parseAmountFromText(text) {
    // หาตัวเลขมากที่สุดที่มีความเป็นเงิน (รองรับ comma/dot)
    // ลอง match เป็นชุดตัวเลขที่อาจมี comma/dot
    const matches = text.match(/([0-9]{1,3}(?:[,\s][0-9]{3})*(?:\.[0-9]+)?|\d+(?:\.\d+)?)/g);
    if (!matches) return null;
    // แปลงแต่ละตัวให้เป็นจำนวนและเลือกตัวที่มีค่าสูงสุด (มักเป็นยอดรวม)
    const nums = matches.map(s => {
      const clean = s.replace(/\s/g,'').replace(/,/g,'');
      return Number(clean);
    }).filter(n => !isNaN(n));
    if (!nums.length) return null;
    nums.sort((a,b) => b - a);
    return nums[0];
  }

  async function processSlip(){
    const btn = document.getElementById('btn');
    btn.disabled = true;
    btn.innerText = "กำลังประมวลผล...";

    const username = document.getElementById('username').value.trim();
    const amountInput = Number(document.getElementById('amount').value);
    const fileEl = document.getElementById('file');
    const file = fileEl.files && fileEl.files[0];

    const resultEl = document.getElementById('result');
    resultEl.style.display = 'none';
    resultEl.innerHTML = '';

    if (!username || !amountInput || !file) {
      alert("กรุณากรอก username, amount และอัปโหลดรูป");
      btn.disabled = false;
      btn.innerText = "ตรวจสลิปและเติมเครดิต";
      return;
    }

    // แสดง preview
    const imgWrap = document.getElementById('imgwrap');
    const preview = document.getElementById('preview');
    imgWrap.innerHTML = '';
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    img.onload = () => URL.revokeObjectURL(img.src);
    imgWrap.appendChild(img);
    preview.style.display = 'block';

    try {
      const base64 = await toBase64(file);

      // run Tesseract OCR
      const worker = Tesseract.createWorker({
        logger: m => {
          // optional: console.log(m);
        }
      });
      await worker.load();
      await worker.loadLanguage('eng+tha'); // english + thai
      await worker.initialize('eng+tha');
      const { data: { text } } = await worker.recognize(file);
      await worker.terminate();

      const ocrText = text || "";

      // parse amount
      const found = parseAmountFromText(ocrText);

      if (!found) {
        resultEl.style.display = 'block';
        resultEl.innerHTML = "<div style='color:red'>ไม่พบตัวเลขในสลิป โปรดอัปโหลดรูปชัด ๆ</div>";
        btn.disabled=false; btn.innerText="ตรวจสลิปและเติมเครดิต";
        return;
      }

      // compare with user-entered amount
      if (Math.abs(found - amountInput) > 0.99) {
        resultEl.style.display = 'block';
        resultEl.innerHTML = `<div style='color:red'>ยอดสลิป (${found}) ไม่ตรงกับยอดที่กรอก (${amountInput})</div><div class='muted'>OCR ข้อความ: <pre>${escapeHtml(ocrText)}</pre></div>`;
        btn.disabled=false; btn.innerText="ตรวจสลิปและเติมเครดิต";
        return;
      }

      // ready to send to server
      const payload = {
        secret: SECRET,
        action: "topup",
        username: username,
        amount: amountInput,
        ocrText: ocrText
      };

      const resp = await fetch(API_URL_GAS, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      const resJson = await resp.json();
      if (resJson.error) {
        resultEl.style.display = 'block';
        resultEl.innerHTML = `<div style='color:red'>Server error: ${resJson.error}</div>`;
      } else {
        resultEl.style.display = 'block';
        resultEl.innerHTML = `<div style='color:green'>เติมสำเร็จ ${resJson.amount || amountInput} บาท ให้ผู้ใช้ ${resJson.username}</div>`;
      }

    } catch (err) {
      console.error(err);
      resultEl.style.display = 'block';
      resultEl.innerHTML = `<div style='color:red'>Error: ${err.message}</div>`;
    } finally {
      btn.disabled=false;
      btn.innerText="ตรวจสลิปและเติมเครดิต";
    }
  }

  function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  </script>
</body>
</html>
