<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>เติมเครดิตอัตโนมัติ</title>
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 400px;
        margin: auto;
        text-align: center;
    }
    input, button {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        font-size: 16px;
    }
    #preview {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        display: none;
        text-align: left;
    }
    #result {
        padding: 15px;
        margin-top: 15px;
        border: 1px solid #ccc;
        display: none;
        text-align: left;
    }
</style>
</head>
<body>

<h2>เติมเครดิตอัตโนมัติ</h2>

<label>ยูสเซอร์เนม:</label>
<input id="username" type="text" placeholder="กรอกยูสเซอร์">

<label>จำนวนเงินที่ต้องการเติม:</label>
<input id="amount" type="number" placeholder="กรอกจำนวนเงิน" oninput="updatePreview()">

<div id="preview">
    <b>สรุปยอดของคุณ:</b><br>
    จำนวนเงิน: <span id="prevAmount">0</span> บาท<br>
    ยอดรวมที่ต้องโอน: <span id="prevTotal">0</span> บาท
</div>

<button onclick="createRequest()">สร้างยอดพร้อมโอน</button>

<div id="result"></div>

<script>

// URL API NGROK
const API_URL = "https://literalistically-superuniversal-estell.ngrok-free.dev/api";

// อัปเดต preview แบบ real-time
function updatePreview() {
    const amount = document.getElementById("amount").value;

    if (!amount || amount <= 0) {
        document.getElementById("preview").style.display = "none";
        return;
    }

    document.getElementById("preview").style.display = "block";
    document.getElementById("prevAmount").innerText = amount;
    document.getElementById("prevTotal").innerText = amount;
}

async function createRequest() {
    const user = document.getElementById("username").value.trim();
    const amount = document.getElementById("amount").value.trim();

    if (!user || !amount) {
        alert("กรุณากรอกข้อมูลให้ครบ");
        return;
    }

    const payload = {
        action: "create_request",
        secret: "yahari",
        username: user,
        amount: Number(amount)  // ใช้แบบตรงๆ
    };

    try {
        let response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        let data = await response.json();

        if (data.error) {
            alert("Error: " + data.error);
            return;
        }

        document.getElementById("result").style.display = "block";
        document.getElementById("result").innerHTML = `
            <b>ยอดที่ต้องโอน:</b> ${data.amount} บาท<br>
            <b>ข้อความบนสลิป:</b> ${data.id}<br><br>
            <b>โอนไปที่เบอร์:</b> 0922503869<br>
            <img src="https://promptpay.io/0922503869/${data.amount}.png" width="200">
        `;
    } catch (err) {
        alert("ระบบผิดพลาด: " + err.message);
    }
}

</script>

</body>
</html>
